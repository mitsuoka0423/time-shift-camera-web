<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Time Shift Camera</title>
  <link href="./destyle.css" rel="stylesheet">
  <style>
    canvas,
    video {
      border: none;
    }

    .video-flex {
      display: flex;
    }
  </style>
</head>

<body>
  <div class="video-flex">
    <div class="video-parent" id="videoParent">
      <canvas id="canvas1"></canvas>
    </div>
    <div class="canvas2-parent" id="canvas2Parent">
      <canvas id="canvas2"></canvas>
    </div>
    <video id="video1" style="display: none;"></video>
  </div>
  <div class="video-flex">
    <div class="video-parent" id="videoParent">
      <canvas id="canvas3"></canvas>
    </div>
    <div class="canvas2-parent" id="canvas2Parent">
      <canvas id="canvas4"></canvas>
    </div>
    <video id="video2" style="display: none;"></video>
  </div>

  <script>
    const FPS = 60;
    let delaySec = 5;

    const showDelayVideo = async (webCameraDeviceId, video, canvasRealTime, canvasDelay) => {
      const imageArray = Array(FPS * delaySec);

      // iOS エラー対策
      video.setAttribute('autoplay', '');
      video.setAttribute('muted', '');
      video.setAttribute('playsinline', '');

      canvasRealTime.width = window.innerWidth / 2;
      canvasRealTime.height = window.innerHeight / 2;

      canvasDelay.width = window.innerWidth / 2;
      canvasDelay.height = window.innerHeight / 2;

      const constraints = {
        audio: false,
        video: {
          deviceId: webCameraDeviceId,
          width: 1920,
          height: 1080,
        },
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      video.onloadedmetadata = (e) => {
        video.play();

        const intervalId = setInterval(function () {
          // canvasRealTimeから画像を取得して変数に入れる
          const picture = canvasRealTime.getContext("2d");
          picture.drawImage(video, 0, 0, canvasRealTime.width, canvasRealTime.height);
          imageArray.push(picture.getImageData(0, 0, canvasRealTime.width, canvasRealTime.height));

          try {
            canvasDelay.getContext('2d').putImageData(imageArray.shift(), 0, 0);
          } catch (e) {
            // エラー時には何もしない
          };
        }, 1000 / FPS);
      };
    }

    const main = async () => {
      const devices = await navigator.mediaDevices.enumerateDevices();
      console.log(devices);

      const webCamera1DeviceId = 'b3e467771429fadd43af9b833e3c59d0d5af9024f54ed108bfea5cf144e3f710';
      const video1 = document.querySelector("#video1");
      const canvas1 = document.querySelector("#canvas1");
      const canvas2 = document.querySelector("#canvas2");
      showDelayVideo(webCamera1DeviceId, video1, canvas1, canvas2);

      const webCamera2DeviceId = '1c23bc7b88c92b392560344b1afbc2858b13c260fcd697de5dce661c0ac4408f';
      const video2 = document.querySelector("#video2");
      const canvas3 = document.querySelector("#canvas3");
      const canvas4 = document.querySelector("#canvas4");
      showDelayVideo(webCamera2DeviceId, video2, canvas3, canvas4);
    };

    window.onload = () => {
      main();
    };
  </script>
</body>

</html>